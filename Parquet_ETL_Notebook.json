{"id": "/subscriptions/0e40d638-6ee2-42fa-83d5-78641df4b3cb/resourceGroups/DataQualityPOC/providers/Microsoft.Synapse/workspaces/synapse-etl-poc/notebooks/Parquet_ETL_Notebook", "name": "Parquet_ETL_Notebook", "type": "Microsoft.Synapse/workspaces/notebooks", "etag": "a6045380-0000-0100-0000-6256add40000", "properties": {"folder": {"name": "Testing_PoC/Parquet"}, "targetSparkConfiguration": null, "entityState": null, "renameOperationDetails": null, "big_data_pool": {"type": "BigDataPoolReference", "reference_name": "apachesparkpool"}, "session_properties": {"driver_memory": "28g", "driver_cores": 4, "executor_memory": "28g", "executor_cores": 4, "num_executors": 2}, "metadata": {"sessionKeepAliveTimeout": 30, "saveOutput": true, "enableDebugMode": false, "a365ComputeOptions": {"id": "/subscriptions/0e40d638-6ee2-42fa-83d5-78641df4b3cb/resourceGroups/DataQualityPOC/providers/Microsoft.Synapse/workspaces/synapse-etl-poc/bigDataPools/apachesparkpool", "name": "apachesparkpool", "type": "Spark", "endpoint": "https://synapse-etl-poc.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/apachesparkpool", "auth": {"type": "AAD", "authResource": "https://dev.azuresynapse.net"}, "sparkVersion": "3.1", "nodeCount": 3, "cores": 8, "memory": 56, "extraHeader": null}, "synapse_widget": {"version": "0.1", "state": {"cd88408c-fad2-4468-ba31-7e9fc04bdf86": {"type": "Synapse.DataFrame", "sync_state": {"table": {"rows": [{"0": "20131231", "1": "10624", "2": "35117", "3": "63879", "4": "64392", "5": "172348", "6": "219532", "7": "40.8124", "8": "-73.9513", "9": "40.8124,-73.9513", "10": "40.7982", "11": "-73.9444", "12": "40.7982,-73.9444", "13": "1", "14": "513", "15": "1.3", "16": "CSH", "17": "7.5000", "18": "1.0000", "19": "0.5000", "20": "0.0000", "21": "0.0000", "22": "9.0000"}, {"0": "20131231", "1": "7263", "2": "11597", "3": "61733", "4": "62114", "5": "87083", "6": "137768", "7": "40.7352", "8": "-73.9857", "9": "40.7352,-73.9857", "10": "40.751", "11": "-73.9789", "12": "40.751,-73.9789", "13": "1", "14": "380", "15": "1.3", "16": "CSH", "17": "7.0000", "18": "1.0000", "19": "0.5000", "20": "0.0000", "21": "0.0000", "22": "8.5000"}, {"0": "20131231", "1": "1899", "2": "5301", "3": "59488", "4": "59815", "5": "82160", "6": "146431", "7": "40.7699", "8": "-73.9483", "9": "40.7699,-73.9483", "10": "40.763", "11": "-73.962", "12": "40.763,-73.962", "13": "1", "14": "326", "15": "1.0", "16": "CSH", "17": "6.0000", "18": "1.0000", "19": "0.5000", "20": "0.0000", "21": "0.0000", "22": "7.5000"}, {"0": "20131231", "1": "9471", "2": "28727", "3": "69093", "4": "69548", "5": "276342", "6": "43408", "7": "40.7507", "8": "-73.9746", "9": "40.7507,-73.9746", "10": "40.7428", "11": "-73.9823", "12": "40.7428,-73.9823", "13": "1", "14": "454", "15": "1.0", "16": "CSH", "17": "7.0000", "18": "1.0000", "19": "0.5000", "20": "0.0000", "21": "0.0000", "22": "8.5000"}, {"0": "20131231", "1": "2556", "2": "16124", "3": "51720", "4": "52440", "5": "155260", "6": "211054", "7": "40.7138", "8": "-74.0119", "9": "40.7138,-74.0119", "10": "40.7494", "11": "-73.9694", "12": "40.7494,-73.9694", "13": "1", "14": "720", "15": "6.11", "16": "CSH", "17": "19.5000", "18": "0.0000", "19": "0.5000", "20": "0.0000", "21": "0.0000", "22": "20.0000"}], "schema": [{"key": "0", "name": "DateID", "type": "int"}, {"key": "1", "name": "MedallionID", "type": "int"}, {"key": "2", "name": "HackneyLicenseID", "type": "int"}, {"key": "3", "name": "PickupTimeID", "type": "int"}, {"key": "4", "name": "DropoffTimeID", "type": "int"}, {"key": "5", "name": "PickupGeographyID", "type": "int"}, {"key": "6", "name": "DropoffGeographyID", "type": "int"}, {"key": "7", "name": "PickupLatitude", "type": "double"}, {"key": "8", "name": "PickupLongitude", "type": "double"}, {"key": "9", "name": "PickupLatLong", "type": "string"}, {"key": "10", "name": "DropoffLatitude", "type": "double"}, {"key": "11", "name": "DropoffLongitude", "type": "double"}, {"key": "12", "name": "DropoffLatLong", "type": "string"}, {"key": "13", "name": "PassengerCount", "type": "int"}, {"key": "14", "name": "TripDurationSeconds", "type": "int"}, {"key": "15", "name": "TripDistanceMiles", "type": "double"}, {"key": "16", "name": "PaymentType", "type": "string"}, {"key": "17", "name": "FareAmount", "type": "decimal"}, {"key": "18", "name": "SurchargeAmount", "type": "decimal"}, {"key": "19", "name": "TaxAmount", "type": "decimal"}, {"key": "20", "name": "TipAmount", "type": "decimal"}, {"key": "21", "name": "TollsAmount", "type": "decimal"}, {"key": "22", "name": "TotalAmount", "type": "decimal"}], "truncated": false}, "isSummary": false, "language": "scala"}, "persist_state": {"view": {"type": "details", "chartOptions": {"chartType": "bar", "aggregationType": "sum", "categoryFieldKeys": ["1"], "seriesFieldKeys": ["0"], "isStacked": false}}}}, "e75271ae-ec67-4eec-b499-9b8fac9bc9cb": {"type": "Synapse.DataFrame", "sync_state": {"table": {"rows": [{"0": "20131231", "1": "10624", "2": "35117", "3": "63879", "4": "64392", "5": "172348", "6": "219532", "7": "8.55", "8": "2.092142"}, {"0": "20131231", "1": "7263", "2": "11597", "3": "61733", "4": "62114", "5": "87083", "6": "137768", "7": "6.333333333333333", "8": "2.092142"}, {"0": "20131231", "1": "1899", "2": "5301", "3": "59488", "4": "59815", "5": "82160", "6": "146431", "7": "5.433333333333334", "8": "1.60934"}, {"0": "20131231", "1": "9471", "2": "28727", "3": "69093", "4": "69548", "5": "276342", "6": "43408", "7": "7.566666666666666", "8": "1.60934"}, {"0": "20131231", "1": "2556", "2": "16124", "3": "51720", "4": "52440", "5": "155260", "6": "211054", "7": "12.0", "8": "9.833067400000001"}], "schema": [{"key": "0", "name": "DateID", "type": "int"}, {"key": "1", "name": "MedallionID", "type": "int"}, {"key": "2", "name": "HackneyLicenseID", "type": "int"}, {"key": "3", "name": "PickupTimeID", "type": "int"}, {"key": "4", "name": "DropoffTimeID", "type": "int"}, {"key": "5", "name": "PickupGeographyID", "type": "int"}, {"key": "6", "name": "DropoffGeographyID", "type": "int"}, {"key": "7", "name": "TripDurationMinutes", "type": "double"}, {"key": "8", "name": "TripDistanceKMs", "type": "double"}], "truncated": false}, "isSummary": false, "language": "scala"}, "persist_state": {"view": {"type": "details", "chartOptions": {"chartType": "bar", "aggregationType": "sum", "categoryFieldKeys": ["1"], "seriesFieldKeys": ["0"], "isStacked": false}}}}}}, "kernelspec": {"name": "synapse_pyspark", "display_name": "Synapse PySpark"}, "language_info": {"name": "python"}}, "nbformat": 4, "nbformat_minor": 2, "cells": [{"execution_count": 1, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}}, "source": ["import pyodbc\r\n", "import openpyxl\r\n", "from openpyxl import load_workbook\r\n", "from openpyxl.utils.dataframe import dataframe_to_rows\r\n", "from openpyxl.worksheet.table import Table, TableStyleInfo\r\n", "import pandas as pd\r\n", "from pyspark.sql import Row, SparkSession\r\n", "import pyspark.sql.functions as F\r\n", "import pyspark.sql.types as T"], "outputs": []}, {"execution_count": 3, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}, "microsoft": {"language": "python"}, "collapsed": false}, "source": ["%%pyspark\r\n", "df = spark.read.load('abfss://etlstoragepocfilesystem@etlstoragepocaccount.dfs.core.windows.net/parquet/TaxiTripsNYC.parquet', format='parquet')\r\n", "display(df.limit(5))"], "outputs": []}, {"execution_count": 4, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}, "microsoft": {"language": "python"}}, "source": ["%%pyspark\r\n", "df.printSchema()"], "outputs": []}, {"execution_count": 5, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}, "microsoft": {"language": "python"}}, "source": ["%%pyspark\r\n", "df.count()"], "outputs": []}, {"execution_count": 6, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}, "microsoft": {"language": "python"}}, "source": ["%%pyspark\r\n", "df.registerTempTable('NYCTaxiTrip')\r\n", "sqlContext.sql('select DateID,MedallionID,HackneyLicenseID,PickupTimeID,DropoffTimeID,PickupGeographyID,DropoffGeographyID,count(1) from NYCTaxiTrip group by DateID,MedallionID,HackneyLicenseID,PickupTimeID,DropoffTimeID,PickupGeographyID,DropoffGeographyID having count(1)>1').show()\r\n", ""], "outputs": []}, {"execution_count": 10, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}, "collapsed": false}, "source": ["df1=df.selectExpr(\"DateID\",\"MedallionID\",\"HackneyLicenseID\",\"PickupTimeID\",\"DropoffTimeID\",\"PickupGeographyID\",\"DropoffGeographyID\",\"`TripDurationSeconds`/60 as `TripDurationMinutes`\",\"`TripDistanceMiles`*1.60934 as `TripDistanceKMs`\")\r\n", "display(df1.limit(5))\r\n", "df1.printSchema()\r\n", "\r\n", ""], "outputs": []}, {"execution_count": 12, "cell_type": "code", "metadata": {"jupyter": {"source_hidden": false, "outputs_hidden": false}, "nteract": {"transient": {"deleting": false}}}, "source": ["jdbcHostname = \"sqlserverdataqualitypoc.database.windows.net\"\r\n", "jdbcDatabase = \"sqldbdataqualitypoc\"\r\n", "jdbcPort = \"1433\"\r\n", "username = \"serveradminlogindatadqualitypoc@sqlserverdataqualitypoc\"\r\n", "password = \"@1234Password\"\r\n", "jdbcUrl = \"jdbc:sqlserver://{0}:{1};database={2}\".format(jdbcHostname, jdbcPort, jdbcDatabase)\r\n", "connectionProperties = {\r\n", "   \"user\" : username,\r\n", "   \"password\" : password,\r\n", "   \"driver\" : \"com.microsoft.sqlserver.jdbc.SQLServerDriver\"\r\n", " }\r\n", "\r\n", "\r\n", "\r\n", "df1.write.jdbc(jdbcUrl,\"sqldbschema.TaxiTripsNYC\", properties=connectionProperties)\r\n", ""], "outputs": []}]}}